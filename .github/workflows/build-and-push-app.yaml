# Runs `.github/workflows/build-and-push-app.yaml` from bcit-ltc/.github
name: Build and push app/chart images

on:
  push:
    branches: [ main ]

jobs:
  build-and-ship:
    uses: bcit-ltc/.github/.github/workflows/build-and-push-app.yaml@main
    permissions:
      contents: write
      packages: write
      id-token: write
      attestations: write
      pull-requests: write
      issues: write
    secrets: inherit

  # Upload static assets to CDN using a content-hash-based CDN_ASSET_VERSION
  upload-cdn-assets:
    needs: build-and-ship
    runs-on: ubuntu-latest
    env:
      APP_VERSION: ${{ needs.build-and-ship.outputs.app_version }}
      IMAGE: ${{ needs.build-and-ship.outputs.app_image }}

      # Where assets live in the *runtime* image
      RUNTIME_STATIC_ROOT: /usr/share/nginx/html
      STATIC_SUBDIR: assets

      CDN_ACCOUNT_NAME: ${{ vars.CDN_ACCOUNT_NAME }}
      CDN_CONTAINER: ${{ vars.CDN_CONTAINER }}
      CDN_NAMESPACE: ${{ github.repository_owner }}
      APP_NAME: ${{ github.event.repository.name }}
      # Base URL for your CDN endpoint (recommend storing in repo/ORG vars)
      CDN_BASE_URL: ${{ vars.CDN_BASE_URL }}

    steps:
      - uses: actions/checkout@v4

      # Compute cdn_asset_version from docs-related files
      - name: Compute CDN asset version
        id: cdn_asset_version
        run: |
          set -euo pipefail

          # Paths that define the docs site
          PATHS="mkdocs.yml docs overrides"

          EXISTING=""
          for p in $PATHS; do
            if [ -e "$p" ]; then
              EXISTING="$EXISTING $p"
            fi
          done

          if [ -z "${EXISTING}" ]; then
            echo "No docs paths found to hash" >&2
            exit 1
          fi

          # Hash the git tree for those paths; first 12 chars is the version
          HASH="$(git ls-tree -r HEAD -- $EXISTING | sha256sum | cut -c1-12)"

          echo "Computed CDN asset version: ${HASH}"
          echo "cdn_asset_version=${HASH}" >> "$GITHUB_OUTPUT"

      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull built image
        run: |
          set -euo pipefail
          docker pull "${IMAGE}:${APP_VERSION}"

      - name: Extract static files from image
        run: |
          set -euo pipefail
          CID="$(docker create "${IMAGE}:${APP_VERSION}")"
          mkdir -p site
          docker cp "${CID}:${RUNTIME_STATIC_ROOT}/." site
          docker rm "${CID}"
          echo "Extracted static files:"
          ls -R site

      - name: Rewrite site asset URLs for CDN
        env:
          CDN_ASSET_VERSION: ${{ steps.cdn_asset_version.outputs.cdn_asset_version }}
        run: |
          set -euo pipefail

          if [ -z "${CDN_BASE_URL}" ]; then
            echo "CDN_BASE_URL is not set; skipping CDN rewrite." >&2
            exit 1
          fi

          CDN_PREFIX="${CDN_BASE_URL%/}/${CDN_NAMESPACE}/${APP_NAME}/${CDN_ASSET_VERSION}"

          echo "Rewriting assets to CDN prefix: ${CDN_PREFIX}"

          # Rewrite relative asset paths produced by MkDocs: "assets/..."
          find site -type f \( -name '*.html' -o -name '*.css' -o -name '*.js' \) -print0 |
            while IFS= read -r -d '' f; do
              sed -i \
                -e "s#\"assets/#\"${CDN_PREFIX}/assets/#g" \
                -e "s#'assets/#'${CDN_PREFIX}/assets/#g" \
                -e "s#(assets/#(${CDN_PREFIX}/assets/#g" \
                "$f"
            done

      - name: Upload assets to CDN
        if: env.CDN_ACCOUNT_NAME != '' && env.CDN_CONTAINER != '' && secrets.CDN_SAS_TOKEN != ''
        uses: azure/CLI@v2
        env:
          SAS_TOKEN: ${{ secrets.CDN_SAS_TOKEN }}
          CDN_ASSET_VERSION: ${{ steps.cdn_asset_version.outputs.cdn_asset_version }}
        with:
          inlineScript: |
            set -euo pipefail

            PREFIX="${CDN_NAMESPACE}/${APP_NAME}/${CDN_ASSET_VERSION}"
            SRC_DIR="site/${STATIC_SUBDIR}"

            if [ ! -d "${SRC_DIR}" ]; then
              echo "ERROR: Expected static subdir ${SRC_DIR} does not exist."
              exit 1
            fi

            echo "Uploading ${SRC_DIR} -> ${PREFIX}/${STATIC_SUBDIR} in container ${CDN_CONTAINER}"

            az storage blob upload-batch \
              --account-name "${CDN_ACCOUNT_NAME}" \
              --sas-token "${SAS_TOKEN}" \
              --destination "${CDN_CONTAINER}" \
              --destination-path "${PREFIX}/${STATIC_SUBDIR}" \
              --source "${SRC_DIR}" \
              --overwrite true \
              --content-cache-control "public, max-age=31536000, immutable"
