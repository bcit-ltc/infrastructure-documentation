# Runs `.github/workflows/build-and-push-app.yaml` from bcit-ltc/.github
name: Build and push app/chart images

on:
  push:
    branches: [ main ]

jobs:
  build-and-ship:
    uses: bcit-ltc/.github/.github/workflows/build-and-push-app.yaml@main
    permissions:
      contents: write
      packages: write
      id-token: write
      attestations: write
      pull-requests: write
      issues: write
    secrets: inherit

  # Upload static assets to CDN using CDN_ASSET_VERSION
  upload-cdn-assets:
    needs: build-and-ship
    runs-on: ubuntu-latest
    env:
      APP_VERSION: ${{ needs.build-and-ship.outputs.app_version }}
      IMAGE: ${{ needs.build-and-ship.outputs.app_image }}

      STATIC_ROOT: /usr/share/nginx/html
      STATIC_SUBDIR: assets

      CDN_ACCOUNT_NAME: ${{ vars.CDN_ACCOUNT_NAME }}
      CDN_CONTAINER: ${{ vars.CDN_CONTAINER }}
      CDN_NAMESPACE: ${{ github.repository_owner }}
      APP_NAME: ${{ github.event.repository.name }}

    steps:
      - uses: actions/checkout@v4

      - name: Read CDN_ASSET_VERSION
        id: cdn_asset_version
        run: |
          set -euo pipefail
          V="$(cat conf.d/cdn/CDN_ASSET_VERSION | tr -d '\r\n' | xargs)"
          echo "cdn_asset_version=${V}" >> "$GITHUB_OUTPUT"

      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull built image
        run: |
          set -euo pipefail
          docker pull "${IMAGE}:${APP_VERSION}"

      - name: Extract static files from image
        run: |
          set -euo pipefail
          CID="$(docker create "${IMAGE}:${APP_VERSION}")"
          mkdir -p site
          docker cp "${CID}:${STATIC_ROOT}/." site
          docker rm "${CID}"
          ls -R site

      - name: Upload assets to CDN
        uses: azure/CLI@v2
        env:
          SAS_TOKEN: ${{ secrets.CDN_SAS_TOKEN }}
          CDN_ASSET_VERSION: ${{ steps.cdn_asset_version.outputs.cdn_asset_version }}
        with:
          inlineScript: |
            set -euo pipefail

            PREFIX="${CDN_NAMESPACE}/${APP_NAME}/${CDN_ASSET_VERSION}"
            echo "Uploading site/${STATIC_SUBDIR} -> ${PREFIX}/${STATIC_SUBDIR} in container ${CDN_CONTAINER}"

            az storage blob upload-batch \
              --account-name "${CDN_ACCOUNT_NAME}" \
              --sas-token "${SAS_TOKEN}" \
              --destination "${CDN_CONTAINER}" \
              --destination-path "${PREFIX}/${STATIC_SUBDIR}" \
              --source "site/${STATIC_SUBDIR}" \
              --overwrite true \
              --content-cache-control "public, max-age=31536000, immutable"
