# Runs `.github/workflows/build-and-push-app.yaml` from bcit-ltc/.github
name: Build and push app/chart images

on:
  push:
    branches: [ main ]

jobs:
  build-and-ship:
    uses: bcit-ltc/.github/.github/workflows/build-and-push-app.yaml@main
    permissions:
      contents: write
      packages: write
      id-token: write
      attestations: write
      pull-requests: write
      issues: write
    secrets: inherit

  # Upload static assets to CDN and rewrite HTML URLs
  #
  # Assumptions:
  # - Runtime frontend image is nginx serving from: /usr/share/nginx/html
  # - CDN_BASE_URL is the storage account root, stored as an org variable
  # - CDN_CONTAINER is the blob container name (e.g., "cdn")
  # - CDN_NAMESPACE is the path segment under the container that represents the org (e.g., "bcit-ltc")
  #
  # Behaviour:
  # - Extracts /usr/share/nginx/html into ./site
  # - Computes CDN_ASSET_VERSION from asset files under ./site for extensions in ASSET_EXTS
  # - Rewrites HTML attributes of the form:
  #       src="./path.ext", href="./path.ext", data-src="./path.ext"
  #   (where ext ∈ ASSET_EXTS)
  #   into:
  #       src="<CDN_BASE_URL>/<CDN_CONTAINER>/<CDN_NAMESPACE>/<app>/<CDN_ASSET_VERSION>/path.ext"
  # - Uploads those asset files to blob paths:
  #     <CDN_CONTAINER>/<CDN_NAMESPACE>/<app>/<CDN_ASSET_VERSION>/<relative-path>
  upload-cdn-assets:
    if: ${{ vars.CDN_ENABLED == '1' }}
    needs: build-and-ship
    runs-on: ubuntu-latest
    env:
      APP_VERSION: ${{ needs.build-and-ship.outputs.app_version }}
      IMAGE: ${{ needs.build-and-ship.outputs.app_image }}

      # Azure storage config (account + container); CDN_SAS_TOKEN is a GitHub secret
      CDN_ACCOUNT_NAME: ${{ vars.CDN_ACCOUNT_NAME }}
      CDN_BASE_URL: ${{ vars.CDN_BASE_URL }}
      CDN_CONTAINER: ${{ vars.CDN_CONTAINER }}
      CDN_NAMESPACE: ${{ vars.CDN_NAMESPACE }}
      CDN_ENABLED: ${{ vars.CDN_ENABLED }}

      # Comma-separated list of asset extensions (no dots), e.g. "jpg,png,js,css,ico"
      ASSET_EXTS: "jpg,png,js,css,ico"

    steps:
      - uses: actions/checkout@v4

      - name: Login to container registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull built image
        run: |
          set -euo pipefail
          docker pull "${IMAGE}:${APP_VERSION}"

      - name: Extract static files from runtime image
        run: |
          set -euo pipefail

          # Fixed runtime static root
          RUNTIME_STATIC_ROOT="/usr/share/nginx/html"

          CID="$(docker create "${IMAGE}:${APP_VERSION}")"
          mkdir -p site
          docker cp "${CID}:${RUNTIME_STATIC_ROOT}/." site
          docker rm "${CID}"

          echo "Extracted static files from ${RUNTIME_STATIC_ROOT} into ./site"
          ls -R site || true

      # Compute CDN asset version from asset files only
      - name: Compute CDN asset version
        id: cdn_asset_version
        env:
          ASSET_EXTS: ${{ env.ASSET_EXTS }}
        run: |
          set -euo pipefail

          SRC_DIR="site"
          ASSET_EXTS="${ASSET_EXTS}"

          echo "Using asset extensions for versioning: ${ASSET_EXTS}"

          # Build a dynamic find expression from ASSET_EXTS
          FIND_EXPR=""
          OLD_IFS="$IFS"
          IFS=','
          for ext in $ASSET_EXTS; do
            ext_trim="$(printf '%s' "$ext" | xargs)"
            [ -z "${ext_trim}" ] && continue
            if [ -z "${FIND_EXPR}" ]; then
              FIND_EXPR="-name '*.${ext_trim}'"
            else
              FIND_EXPR="${FIND_EXPR} -o -name '*.${ext_trim}'"
            fi
          done
          IFS="$OLD_IFS"

          if [ -z "${FIND_EXPR}" ]; then
            echo "No valid asset extensions in ASSET_EXTS; using fallback CDN asset version." >&2
            VERSION="noassets000000"
            echo "cdn_asset_version=${VERSION}" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Collect asset files
          ASSET_FILES="$(
            eval "find \"${SRC_DIR}\" -type f \\( ${FIND_EXPR} \\) -print0" | tr '\0' '\n' || true
          )"

          if [ -z "${ASSET_FILES}" ]; then
            echo "No matching asset files in ${SRC_DIR}; using fallback CDN asset version." >&2
            VERSION="noassets000000"
            echo "cdn_asset_version=${VERSION}" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          HASH="$(
            eval "find \"${SRC_DIR}\" -type f \\( ${FIND_EXPR} \\) -print0" \
              | sort -z \
              | xargs -0 sha256sum \
              | sha256sum \
              | cut -c1-12
          )"

          echo "Computed CDN asset version from assets: ${HASH}"
          echo "cdn_asset_version=${HASH}" >> "$GITHUB_OUTPUT"

      - name: Rewrite HTML asset URLs for CDN
        env:
          CDN_ASSET_VERSION: ${{ steps.cdn_asset_version.outputs.cdn_asset_version }}
          CDN_BASE_URL: ${{ env.CDN_BASE_URL }}
          CDN_CONTAINER: ${{ env.CDN_CONTAINER }}
          CDN_NAMESPACE: ${{ env.CDN_NAMESPACE }}
          ASSET_EXTS: ${{ env.ASSET_EXTS }}
        run: |
          set -euo pipefail

          CDN_BASE_URL="${CDN_BASE_URL}"
          CDN_CONTAINER="${CDN_CONTAINER}"
          CDN_NAMESPACE="${CDN_NAMESPACE}"
          APP_NAME="${{ github.event.repository.name }}"
          CDN_ASSET_VERSION="${CDN_ASSET_VERSION}"
          ASSET_EXTS="${ASSET_EXTS}"

          if [ -z "${CDN_ASSET_VERSION}" ]; then
            echo "CDN_ASSET_VERSION is empty; skipping rewrite." >&2
            exit 0
          fi

          if [ -z "${CDN_BASE_URL}" ] || [ -z "${CDN_CONTAINER}" ]; then
            echo "CDN_BASE_URL or CDN_CONTAINER is not set; skipping rewrite." >&2
            exit 0
          fi

          # Build CDN prefix: <base>/<container>/<namespace>/<app>/<version>
          CDN_PREFIX="${CDN_BASE_URL%/}/${CDN_CONTAINER}/${CDN_NAMESPACE}/${APP_NAME}/${CDN_ASSET_VERSION}"

          # Build regex alternation for extensions: e.g. "jpg|png|js|css|ico"
          EXT_PATTERN="$(printf '%s' "${ASSET_EXTS}" | tr -d '[:space:]' | sed 's/,/|/g')"

          if [ -z "${EXT_PATTERN}" ]; then
            echo "No valid extensions in ASSET_EXTS; skipping rewrite." >&2
            exit 0
          fi

          echo "Rewriting HTML assets to CDN prefix: ${CDN_PREFIX}"
          echo "Matching extensions: ${ASSET_EXTS}"

          # Rewrite only HTML files; look for:
          #   src="./path.ext"
          #   href="./path.ext"
          #   data-src="./path.ext"
          # where ext ∈ ASSET_EXTS.
          find site -type f -name '*.html' -print0 |
            while IFS= read -r -d '' f; do
              sed -E -i \
                -e "s#(src|href|data-src)=([\"'])\./([^\"']+\.(${EXT_PATTERN}))\2#\1=\2${CDN_PREFIX}/\3\2#g" \
                "$f"
            done

      - name: Upload assets to CDN
        uses: azure/CLI@v2
        env:
          SAS_TOKEN: ${{ secrets.CDN_SAS_TOKEN }}
          CDN_ACCOUNT_NAME: ${{ env.CDN_ACCOUNT_NAME }}
          CDN_CONTAINER: ${{ env.CDN_CONTAINER }}
          CDN_NAMESPACE: ${{ env.CDN_NAMESPACE }}
          CDN_ASSET_VERSION: ${{ steps.cdn_asset_version.outputs.cdn_asset_version }}
          ASSET_EXTS: ${{ env.ASSET_EXTS }}
        with:
          inlineScript: |
            set -euo pipefail

            if [ -z "${SAS_TOKEN:-}" ] || [ -z "${CDN_ACCOUNT_NAME:-}" ] || [ -z "${CDN_CONTAINER:-}" ]; then
              echo "CDN upload config incomplete (missing SAS_TOKEN/CDN_ACCOUNT_NAME/CDN_CONTAINER); skipping upload."
              exit 0
            fi

            SRC_DIR="site"
            if [ ! -d "${SRC_DIR}" ]; then
              echo "No site dir ${SRC_DIR}; nothing to upload." >&2
              exit 0
            fi

            CDN_NAMESPACE="${CDN_NAMESPACE}"
            APP_NAME="${{ github.event.repository.name }}"
            CDN_ASSET_VERSION="${CDN_ASSET_VERSION}"
            ASSET_EXTS="${ASSET_EXTS}"

            # Blob path prefix under the container; container itself is not included here.
            PREFIX="${CDN_NAMESPACE}/${APP_NAME}/${CDN_ASSET_VERSION}"

            echo "Uploading assets from ${SRC_DIR} to container ${CDN_CONTAINER} at prefix ${PREFIX}"
            echo "Using asset extensions: ${ASSET_EXTS}"

            # Upload only selected asset types; preserve directory structure under SRC_DIR.
            OLD_IFS="$IFS"
            IFS=','
            for ext in $ASSET_EXTS; do
              ext_trim="$(printf '%s' "$ext" | xargs)"
              [ -z "${ext_trim}" ] && continue
              pattern="*.${ext_trim}"
              echo "  - Uploading assets matching pattern: ${pattern}"
              az storage blob upload-batch \
                --account-name "${CDN_ACCOUNT_NAME}" \
                --sas-token "${SAS_TOKEN}" \
                --destination "${CDN_CONTAINER}" \
                --destination-path "${PREFIX}" \
                --source "${SRC_DIR}" \
                --pattern "${pattern}" \
                --overwrite true \
                --content-cache-control "public, max-age=31536000, immutable"
            done
            IFS="$OLD_IFS"
